# # defines automation services (optional)
# services:
#     # serviceReference is an identifier for the service within the environment.
#     # It is used when referencing the service, e.g. from the CLI.
#     # It needs to only contain alphanumeric characters, underscores, and hyphens, and must be between 1 and 128 characters long.
#     fakeWebServices:
#         name: Fake Web Services
#         triggeredBy:
#           - postEnvironmentStart
#         commands:
#           start: sleep 5 && python3 -m http.server 8000 & python3 -m http.server 3000

#     openURLs:
#         # Name is a required, human readable string.
#         name: Open URLs in browser
#         description: Click on the URLs to open them in your browser
#         # triggeredBy lists all trigger that start the service. If none are provided the service isn't started automatically.
#         # See below for a complete list of trigger.
#         triggeredBy:
#             # postEnvironmentStart activates every time the environment is started, e.g. on first start
#             - postEnvironmentStart
#             # postDevcontainerStart activates every time the devcontainer is started, e.g. on first start or devcontainer rebuild
#             - postDevcontainerStart
#             # manual trigger provides a unique affordance in the user interface, allowing developers to start an action on demand.
#             - manual
#         commands:
#             # start is a mandatory command constitutes the service itself and is expected to continue running until stopped.
#             # If this command fails (i.e. exits with a non-zero exit code), the service is considered failed.
#             start: |
#                 function check_port() {
#                     if { exec 3<>/dev/tcp/127.0.0.1/$1; } 2>/dev/null; then
#                         exec 3<&-  # Close input
#                         exec 3>&-  # Close output
#                         return 0
#                     else
#                         return 1
#                     fi
#                 }

#                 until check_port 3000 && check_port 8000; do
#                     echo "Port 3000 & 8000 not ready yet..."
#                     sleep 1
#                 done

#                 echo "Click on the URLs to open them in your browser"
#                 echo "Frontend preview: https://localhost:8000"
#                 echo "Testing: https://localhost:3000"



services:
    mysql:
        name: MySQL Service
        description: Runs MySQL server manually and keeps it alive while port 3306 is open
        triggeredBy:
            - postDevcontainerStart
            # - postEnvironmentStart
        commands:
            start: |
                # Start mysql server in safe mode
                mysqld_safe --datadir=/var/lib/mysql \
                            --socket=/var/run/mysqld/mysqld.sock \
                            --pid-file=/var/run/mysqld/mysqld.pid \
                            --user=mysql &

                # Wait before running setup
                sleep 10

                # Run mysql setup script
                chmod +x .gitpod/setup/setup_mysql.sh && .gitpod/setup/setup_mysql.sh

                # Keep service alive while port 3306 is open
                chmod +x .gitpod/helpers/keep-alive-until-port-closed.sh
                .gitpod/helpers/keep-alive-until-port-closed.sh localhost 3306 5 3
            stop: mysqladmin -u root -proot shutdown || true
            
    redis:
        name: Redis Service
        description: Runs Redis server in background and keeps it alive while port 6379 is open
        triggeredBy:
            - postDevcontainerStart
            # - postEnvironmentStart
        commands:
            start: |
                # Start redis in background
                redis-server --daemonize yes

                # Keep service alive while port 6379 is open
                chmod +x .gitpod/helpers/keep-alive-until-port-closed.sh
                .gitpod/helpers/keep-alive-until-port-closed.sh localhost 6379 5 3
            stop: redis-cli shutdown
            
    php-server:
        name: PHP Development Server
        description: Runs Laravel setup and starts PHP built-in server
        triggeredBy:
            - postDevcontainerStart
            # - postEnvironmentStart
        commands:
            start: |
                # Run base environment setup
                chmod +x .gitpod/setup/setup_environment.sh && .gitpod/setup/setup_environment.sh

                # Run laravel setup (composer + artisan)
                chmod +x .gitpod/setup/setup_laravel.sh && .gitpod/setup/setup_laravel.sh

                # Restart tail process for logs
                killall -q tail || true
                touch storage/logs/laravel.log
                tail -f -n 0 storage/logs/laravel.log | egrep -v '^#' &

                # Start php built-in server
                PHP_CLI_SERVER_WORKERS=10 php -S 0.0.0.0:8000 -t public .gitpod/cachingRouter.php
            stop: killall php || true
            
    npm-hot-reload:
        name: NPM Hot Reload Service
        description: Installs dependencies and runs Laravel Mix hot reload server
        triggeredBy:
            - postDevcontainerStart
            # - postEnvironmentStart
        commands:
            start: |
                # Install NPM dependencies & run hot reload server
                npm install
                npm run hot-gitpod
            stop: killall node || true
            
    expose-tunnel:
        name: Expose.dev Tunnel Server
        description: Creates public tunnel for Laravel dev server via Expose.dev
        triggeredBy:
            - postDevcontainerStart
            # - postEnvironmentStart
        commands:
            start: |
                # Run custom port setup
                chmod +x .gitpod/setup/setup_ports.sh && .gitpod/setup/setup_ports.sh

                # Authenticate expose client
                .gitpod/expose token ${EXPOSE_DEV_TOKEN}

                # Keep sharing tunnel to expose.dev
                while true; do 
                .gitpod/expose share http://0.0.0.0:8000 \
                    --domain=dev.ideasoverflow.nl \
                    --server=eu-1 \
                    --subdomain=${EXPOSE_SUBDOMAIN_HANSON}
                sleep 5
                done
            stop: killall expose || true

    queue-worker:
        name: Laravel Queue Worker
        description: Waits for port 8000 and starts a Laravel queue worker
        triggeredBy:
            - postDevcontainerStart
            # - postEnvironmentStart
        commands:
            start: |
                # Wait for port 8000 using helper
                chmod +x .gitpod/helpers/wait-for-port.sh
                .gitpod/helpers/wait-for-port.sh localhost 8000

                # Run worker for specified queue (default if not provided)
                php artisan queue:work --queue=default,website-requests,offer-maintenances,analytics,mailchimp,user-emails,offers-export
            stop: killall php || true
